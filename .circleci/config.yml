---
version: 2.1

executors:
  rocky8: &rocky8-executor
    docker:
      - image: cimg/base:current
jobs:
  build:
    parameters:
      os:
        type: executor
      install-type:
        type: string
      string_os:
        type: string
    executor: << parameters.os >>
    environment:
      COMPOSER_ALLOW_SUPERUSER: 1
      XDMOD_REALMS: 'jobs,storage,cloud,resourcespecifications,supremm,jobefficiency'
      QA_BRANCH: 'v2'
      TRAVIS_COMMIT_RANGE: << pipeline.git.base_revision >>..<<pipeline.git.revision>>
      XDMOD_IS_CORE: yes
      XDMOD_INSTALL_DIR: /root/xdmod
      MODULE_INSTALL_DIR: /root/xdmod-supremm
      XDMOD_TEST_MODE: << parameters.install-type >>
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Docker Compose corresponding OS file
          command: docker compose -f ~/project/tests/playwright/Docker/docker-compose.yml up -d
      - run:
          name: Generate Key for XDMoD
          command: docker exec xdmod openssl genrsa -out /etc/pki/tls/private/localhost.key -rand /proc/cpuinfo:/proc/filesystems:/proc/interrupts:/proc/ioports:/proc/uptime 2048
      - run:
          name: Generate Cert for XDMoD
          command: docker exec xdmod /usr/bin/openssl req -new -key /etc/pki/tls/private/localhost.key -x509 -sha256 -days 365 -set_serial $RANDOM -extensions v3_req -out /etc/pki/tls/certs/localhost.crt -subj "/C=XX/L=Default City/O=Default Company Ltd"
      - run:
          name: Checkout XDMoD
          command: |
            git clone --depth=1 https://github.com/ubccr/xdmod.git ../xdmod
      - run:
          name: Copy Files for Playwright and XDMoD containers
          command: |
            docker cp ~/project/../xdmod xdmod:$XDMOD_INSTALL_DIR
            docker cp ~/project xdmod:$MODULE_INSTALL_DIR
            docker cp ~/project/../xdmod playwright:$XDMOD_INSTALL_DIR
            docker cp ~/project playwright:$MODULE_INSTALL_DIR
      - run:
          name: Link the Supremm Module into XDMoD's directory structure
          command: |
            docker exec -w $MODULE_INSTALL_DIR xdmod ln -s $MODULE_INSTALL_DIR $XDMOD_INSTALL_DIR/open_xdmod/modules/supremm
            docker exec -w $MODULE_INSTALL_DIR playwright ln -s $MODULE_INSTALL_DIR $XDMOD_INSTALL_DIR/open_xdmod/modules/supremm
      - run:
          name: Create test result directories
          command: |
            rm -rf ~/phpunit
            mkdir ~/phpunit
            rm -rf /tmp/screenshots
            mkdir /tmp/screenshots
      - run:
          name: Create Test Artifact Directories in XDMoD
          command: |
            docker exec xdmod mkdir /root/phpunit
            docker exec xdmod mkdir /tmp/screenshots
            docker exec xdmod mkdir /root/code_coverage_raw
            docker exec xdmod mkdir /root/code_coverage
      - run:
          name: Install XDMoD Composer Dependencies
          command: |
            docker exec -w $XDMOD_INSTALL_DIR xdmod composer install
            docker exec -w $MODULE_INSTALL_DIR xdmod composer install
      - run:
          name: Build XDMoD RPM
          command: docker exec -w $XDMOD_INSTALL_DIR xdmod /root/bin/buildrpm xdmod supremm
      - run:
          name: Install / Upgrade XDMoD from the newly created RPM
          command: docker exec -e XDMOD_TEST_MODE=<< parameters.install-type >> xdmod $XDMOD_INSTALL_DIR/open_xdmod/modules/supremm/tests/integration/scripts/bootstrap.sh
      - run:
          name: Validate that the install / upgrade went as expected
          command: docker exec -w $MODULE_INSTALL_DIR xdmod ./tests/integration/scripts/validate.sh
      - run:
          name: Make sure that the test dependencies are installed
          command: |
            docker exec -w $XDMOD_INSTALL_DIR xdmod composer install
            docker exec -w $MODULE_INSTALL_DIR xdmod composer install
      - when:
          condition:
            equal: [ << parameters.install-type >>, 'upgrade' ]
          steps:
            - run:
                name: Setup & Run QA Tests
                command: docker exec -w $MODULE_INSTALL_DIR xdmod ./tests/ci/scripts/qa-test-setup.sh
      - run:
          name: Run Post Install Tests
          command: docker exec -w $MODULE_INSTALL_DIR xdmod ./tests/ci/scripts/post-install-test.sh
      - run:
          name: Run Component Tests
          command: docker exec -w $MODULE_INSTALL_DIR xdmod ./tests/component/runtests.sh --log-junit ~/phpunit/component.xml
      - run:
          name: Setup Configuration Files for Integration Tests
          command: |
            docker exec xdmod mv $XDMOD_INSTALL_DIR/configuration/organization.json $XDMOD_INSTALL_DIR/configuration/organization.json.old
            docker exec xdmod mv $XDMOD_INSTALL_DIR/configuration/portal_settings.ini $XDMOD_INSTALL_DIR/configuration/portal_settings.ini.old
            docker exec xdmod cp /etc/xdmod/portal_settings.ini $XDMOD_INSTALL_DIR/configuration/portal_settings.ini
            docker exec xdmod cp /etc/xdmod/organization.json $XDMOD_INSTALL_DIR/configuration/organization.json

      - run:
          name: Running Integration Tests
          command: docker exec -w $MODULE_INSTALL_DIR xdmod ./tests/integration/runtests.sh --log-junit ~/phpunit/integration.xml
      - run:
          name: Run Regression Tests
          command: docker exec -w $XDMOD_INSTALL_DIR xdmod ./tests/regression/runtests.sh --junit-output-dir ~/phpunit
      - run:
          name: Copy Test Results into Unit
          command: |
            docker cp xdmod:/root/phpunit ~/phpunit
            docker cp xdmod:/tmp/screenshots /tmp/screenshots
            mkdir ~/project/log ~/project/log/xdmod ~/project/log/php-fpm
            docker cp xdmod:/var/log/xdmod/. ~/project/log/xdmod
            docker cp xdmod:/var/log/php-fpm/. ~/project/log/php-fpm
          when: always
      - run:
          name: Check for webserver errors
          command: |
            if [ -e ~/project/log/xdmod/apache-error.log ]; then
                test "$(fgrep -v ' [ssl:warn] ' ~/project/log/apache-error.log | wc -l)" = 0
            fi
      - run:
          name: Check for php-fpm errors
          command: |
            if [ -s ~/project/log/php-fpm/www-error.log ]; then
                echo "Errors seen in php fpm log";
                false;
            else
                echo "PHP fpm error log file is empty"
            fi
      - run:
          name: Check for etl_overseer errors
          command: |
            if grep -q error ~/project/log/xdmod/etl_overseer.log
            then
                echo "Errors seen in etl_overseer.log"
                false;
            fi
      - run:
          name: Run Destructive Tests
          command: ./tests/integration/final_tests.sh
      - run:
          name: Ensure that no PHP command-line errors were generated
          command: |
            docker exec xdmod /bin/bash -c "if [ -s /var/log/php_errors.log ]; then cat /var/log/php_errors.log; false; fi"
      - store_artifacts:
          path: /tmp/screenshots
      - store_artifacts:
          path: ~/project/log
      - store_test_results:
          path: ~/phpunit

workflows:
  full-build:
    jobs:
      - build:
          matrix:
            parameters:
              os: [rocky8]
              install-type: ["fresh_install", "upgrade"]
              string_os: [rocky8]
